const findBoxInDb = require("./findBoxModule.ts");
const { TOKEN } = require("./token.ts");
const TelegramApi = require("node-telegram-bot-api");
const {
    menu,
    catalog,
    boxesCatalog,
    packingCatalog,
    papersCatalog,
    wantToBuy,
} = require("./options.ts");

const fileOptions = {
    filename: "price_boxes.pdf",
    contentType: "application/pdf",
};

const bot = new TelegramApi(TOKEN, { polling: true });
const regex =
    /^(?:100|[1-9][0-9]?)\D+(?:100|[1-9][0-9]?)\D+(?:100|[1-9][0-9]?)$/;

const start = () => {
    bot.setMyCommands([
        {
            command: "/start",
            description: "–ù–∞—á–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ",
        },
    ]);

    bot.on("message", async (msg: any) => {
        const { text, chat } = msg;
        const chatId = chat.id;
        console.log(text);

        if (text.match(regex)) {
            const boxFound = await findBoxInDb.findBox(text);
            let boxMessage;

            if (typeof boxFound === "string") {
                boxMessage = boxFound;
            } else {
                boxMessage =
                    `ü•≥ –£–†–ê! –ú—ã –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â—É—é –≤–∞–º –∫–æ—Ä–æ–±–∫—É! \n–ï–µ —Ä–∞–∑–º–µ—Ä—ã ${boxFound.size} —Å–º. \n\nüíµ –¶–µ–Ω–∞ –∫–æ—Ä–æ–±–∫–∏:\n–∏–∑ —Ü–≤–µ—Ç–Ω–æ–≥–æ –∫–∞—Ä—Ç–æ–Ω–∞ ${boxFound.priceColor} BYN` +
                    (boxFound.priceCraft
                        ? `, \n–∏–∑ –∫—Ä–∞—Ñ—Ç–æ–≤–æ–≥–æ –∫–∞—Ä—Ç–æ–Ω–∞ ${boxFound.priceCraft} BYN`
                        : "");
            }
            return bot.sendMessage(chatId, boxMessage, wantToBuy);
        } else {
            switch (text) {
                case "/start": {
                    const stickerNum = Math.floor(Math.random() * 10);
                    const firstName = msg.from?.first_name;
                    const lastName = msg.from?.last_name || "";

                    await bot.sendSticker(
                        chatId,
                        `./assets/gift${stickerNum}.tgs`
                    );
                    const welcomeMessage = lastName
                        ? `üëã –ü—Ä–∏–≤–µ—Ç, ${firstName} ${lastName}!\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –º–∞–≥–∞–∑–∏–Ω —É–ø–∞–∫–æ–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤!\n–ú—ã —Å–æ–∑–¥–∞–µ–º –≤–æ–ª—à–µ–±—Å—Ç–≤–æ –≤ –∫–∞–∂–¥–æ–π —É–ø–∞–∫–æ–≤–∫–µ. –ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º –≤—ã–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—É—é —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ª—é–±–æ–≥–æ —Å–ª—É—á–∞—è. –†–∞–¥—ã –±—ã—Ç—å —á–∞—Å—Ç—å—é –≤–∞—à–∏—Ö –æ—Å–æ–±—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤!\n\n–° –Ω–∞–∏–ª—É—á—à–∏–º–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏,\n–ö–æ–º–∞–Ω–¥–∞ '–ë—É–º–∞–∂–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏!'`
                        : `üëã –ü—Ä–∏–≤–µ—Ç, ${firstName}!\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –º–∞–≥–∞–∑–∏–Ω —É–ø–∞–∫–æ–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤!\n–ú—ã —Å–æ–∑–¥–∞–µ–º –≤–æ–ª—à–µ–±—Å—Ç–≤–æ –≤ –∫–∞–∂–¥–æ–π —É–ø–∞–∫–æ–≤–∫–µ. –ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º –≤—ã–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—É—é —É–ø–∞–∫–æ–≤–∫—É –¥–ª—è –ª—é–±–æ–≥–æ —Å–ª—É—á–∞—è. –†–∞–¥—ã –±—ã—Ç—å —á–∞—Å—Ç—å—é –≤–∞—à–∏—Ö –æ—Å–æ–±—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤!\n\n–° –Ω–∞–∏–ª—É—á—à–∏–º–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏,\n–ö–æ–º–∞–Ω–¥–∞ '–ë—É–º–∞–∂–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏!'`;

                    return bot.sendMessage(chatId, welcomeMessage, menu);
                }
                case "üè† –ê–¥—Ä–µ—Å": {
                    const addressMessage =
                        "üìç –ù–∞—à –º–∞–≥–∞–∑–∏–Ω –ø–æ–¥–∞—Ä–∫–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: \n—É–ª. –ü—Ä–∏—Ç—ã—Ü–∫–æ–≥–æ, 156, –¢–¶ ¬´–ì—Ä–∏–Ω –°–∏—Ç–∏¬ª, –ú–∏–Ω—Å–∫, –ë–µ–ª–∞—Ä—É—Å—å, \n\nüó∫ https://yandex.by/maps/-/CHdRr~a";
                    return bot.sendMessage(chatId, addressMessage);
                }
                case "üïô –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:": {
                    const workHoursMessage =
                        "üïô –ú—ã —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –í–∞—Å –Ω–∞ –Ω–∞—à–µ–º –∫–æ—Ä–Ω–µ—Ä–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 10.00 –¥–æ 22.00";
                    return bot.sendMessage(chatId, workHoursMessage);
                }
                case "üì∑ –ú—ã –≤ Instagram": {
                    const instagramMessage =
                        "üì∑ –ó–¥–µ—Å—å –≤—ã –æ–±—Ä–µ—Ç–µ—Ç–µ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤, —É–∑–Ω–∞–µ—Ç–µ –æ –Ω–æ–≤–∏–Ω–∫–∞—Ö –ø–µ—Ä–≤—ã–º–∏ –∏ –ø–æ–ª—É—á–∏—Ç–µ —à–∞–Ω—Å –≤—ã–∏–≥—Ä–∞—Ç—å —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑—ã: \n\nhttps://instagram.com/bymaga_shop";
                    return bot.sendMessage(chatId, instagramMessage);
                }
                case "üõçÔ∏è –ö–∞—Ç–∞–ª–æ–≥": {
                    const catalogMessage = "üõí –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å —Ç–æ–≤–∞—Ä";
                    return bot.sendMessage(chatId, catalogMessage, catalog);
                }
                default: {
                    const errorMessage =
                        "–Ø –≤–∞—Å –Ω–µ –ø–æ–Ω—è–ª, —Å–¥–µ–ª–∞–π—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à –∑–∞–ø—Ä–æ—Å –µ—â–µ —Ä–∞–∑!";
                    return bot.sendMessage(chatId, errorMessage);
                }
            }
        }
    });

    bot.on("callback_query", async (msg: any) => {
        const data = msg.data;
        const chatId = msg.message?.chat.id;

        switch (data) {
            case "boxes":
                await bot.sendPhoto(chatId, "./assets/box.jpeg");
                await bot.sendMessage(
                    chatId,
                    "üì¶ –£ –Ω–∞—Å –æ–≥—Ä–æ–º–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –∫–æ—Ä–æ–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —É–ø–∞–∫–æ–≤–∫–∏ –ª—é–±—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤. –í—Å–µ –∫–æ—Ä–æ–±–∫–∏ —Å–¥–µ–ª–∞–Ω—ã –∏–∑ –ø—Ä–æ—á–Ω–æ–≥–æ –∫–∞—Ä—Ç–æ–Ω–∞ –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞, —á—Ç–æ–±—ã –≤–∞—à –ø–æ–¥–∞—Ä–æ–∫ –±—ã–ª –Ω–∞–¥–µ–∂–Ω–æ –∑–∞—â–∏—â–µ–Ω. –í –Ω–∞—à–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ –º–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤, —á—Ç–æ–±—ã —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç—å –≤—Å–µ –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –≤–∫—É—Å—ã.\n\n–ê—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –∫–æ—Ä–æ–±–æ–∫ –∏ —Ü–µ–Ω—ã –≤—ã –º–æ–∂–µ—Ç–µ —É–∑–Ω–∞—Ç—å –∏–∑ –Ω–∞—à–µ–≥–æ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ üëáüèº",
                    boxesCatalog
                );
                break;
            case "stickers":
                await bot.sendPhoto(chatId, "./assets/stickers.jpg");
                await bot.sendMessage(
                    chatId,
                    "ü©µ –ù–∞—à –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –æ–±—ä–µ–º–Ω—ã—Ö –Ω–∞–∫–ª–µ–µ–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –¥–∏–∑–∞–π–Ω—ã –∏ –≤–∫–ª—é—á–∞–µ—Ç —Å–µ—Ä–¥–µ—á–∫–∏ üíï, —Ü–≤–µ—Ç—ã üåº, —Ñ—Ä—É–∫—Ç—ã üçì, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –Ω–∞–¥–ø–∏—Å–∏ üàµ –∏ –∑–Ω–∞–∫–∏ –∑–æ–¥–∏–∞–∫–∞ ‚ôäÔ∏è. \n\n–≠—Ç–∏ –Ω–∞–∫–ª–µ–π–∫–∏ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —É–∫—Ä–∞—à–µ–Ω–∏—è —á–µ—Ö–ª–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤, –∞ —Ç–∞–∫–∂–µ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —É–∫—Ä–∞—à–µ–Ω–∏—è –Ω–æ—É—Ç–±—É–∫–æ–≤, –∫—Ä—É–∂–µ–∫, –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤. \n\n–¶–µ–Ω–∞ –∑–∞ –∫–∞–∂–¥—É—é –Ω–∞–∫–ª–µ–π–∫—É —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç 1 –¥–æ 2,5 —Ä—É–±–ª–µ–π, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º–∏ –¥–ª—è —à–∏—Ä–æ–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏."
                );
                break;
            case "papers":
                await bot.sendMessage(
                    chatId,
                    "üìÉ –í—ã–±–µ—Ä–∏—Ç–µ –±—É–º–∞–≥—É",
                    papersCatalog
                );
                break;
            case "catalog":
                await bot.sendMessage(
                    chatId,
                    "üõí –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å —Ç–æ–≤–∞—Ä",
                    catalog
                );
                break;
            case "packing":
                await bot.sendPhoto(chatId, "./assets/packing.jpg");
                await bot.sendMessage(
                    chatId,
                    "–£ –Ω–∞—Å –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø–∞–∫–æ–≤–∫–∏ –≤–∞—à–∏—Ö –ø–æ–¥–∞—Ä–∫–æ–≤. –ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã—Ö —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤ –∑–∞–±–æ—Ç–ª–∏–≤–æ –æ–±–µ—Ä–Ω–µ—Ç –∫–∞–∂–¥—ã–π –ø–æ–¥–∞—Ä–æ–∫ –≤ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –±—É–º–∞–≥—É, —á—Ç–æ–±—ã –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –µ–≥–æ —Å—Ç–∏–ª—å –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏. –ú—ã –æ–±—Ä–∞—â–∞–µ–º –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥—É—é –¥–µ—Ç–∞–ª—å –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–µ –ª–µ–Ω—Ç—ã –∏ –±–∞–Ω—Ç—ã, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∏ —Ä–æ—Å–∫–æ—à–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥. –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –Ω–∞—à–µ–π —Ä–∞–±–æ—Ç—ã —Å—Ç–∞–Ω–µ—Ç —É–ø–∞–∫–æ–≤–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ—Ä–∞–¥—É–µ—Ç –≤–∞—Å, –Ω–æ –∏ –¥–æ–±–∞–≤–∏—Ç –æ—Å–æ–±—É—é –∏–∑—ã—Å–∫–∞–Ω–Ω–æ—Å—Ç—å –≤–∞—à–∏–º –ø–æ–¥–∞—Ä–∫–∞–º.",
                    packingCatalog
                );
                break;
            case "price_boxes":
                await bot.sendDocument(
                    chatId,
                    "./assets/prices/price_boxes.pdf"
                );
                break;
            case "price_packing":
                await bot.sendDocument(
                    chatId,
                    "./assets/prices/price_packing.pdf"
                );
                break;
            case "find_box":
                await bot.sendMessage(
                    chatId,
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≥–∞–±–∞—Ä–∏—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã (–¥–ª–∏–Ω–∞, —à–∏—Ä–∏–Ω–∞ –∏ –≤—ã—Å–æ—Ç–∞) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –≤–∞–º –∫–æ—Ä–æ–±–∫–∏ –≤ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä 10/10/10"
                );
                break;
            case "buy":
                await bot.sendMessage(
                    chatId,
                    `–ö—É–ø–∏—Ç—å –∫–æ—Ä–æ–±–∫—É –º–æ–∂–Ω–æ –Ω–∞ –Ω–∞—à–µ–º –∫–æ—Ä–Ω–µ—Ä–µ –≤ –¢–¶ "Green" –ø–æ –∞–¥—Ä–µ—Å—É:\n\n—É–ª. –ü—Ä–∏—Ç—ã—Ü–∫–æ–≥–æ, –¥. 156\n\n–í –ª—é–±–æ–π –¥–µ–Ω—å —Å 10.00 –¥–æ 22.00\n\nüó∫ https://yandex.by/maps/-/CHdRr~a`
                );
                break;
        }
    });
};

start();
